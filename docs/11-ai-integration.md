# 11 â€” AI Integration Design

## Overview

Add LLM-powered intelligence to the conversation engine. AI **augments** the existing rule-based state machine â€” it does not replace it. The state machine remains the source of truth for data flow (search â†’ disambiguate â†’ portion â†’ resolve), while AI handles natural language understanding and response generation.

## Goals

1. **Better input understanding** â€” Replace regex parser with AI that truly understands Finnish natural language
2. **Natural responses** â€” Replace template strings with conversational Finnish generated by AI
3. **Smart suggestions** â€” Proactively suggest companions, estimate portions, detect missing items
4. **Graceful degradation** â€” Falls back to regex parser if AI is unavailable or too slow

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  User Message                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            AI Parser Layer (optional)              â”‚
â”‚  - Structured extraction via tool_use/functions    â”‚
â”‚  - Intent, items, amounts, units, confidence       â”‚
â”‚  - Falls back to regex parser on failure           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Existing State Machine (unchanged)         â”‚
â”‚  - Fineli search, ranking, disambiguation          â”‚
â”‚  - Portion conversion, nutrient calculation        â”‚
â”‚  - State transitions (PARSED â†’ RESOLVED)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AI Response Layer (optional)               â”‚
â”‚  - Natural Finnish from engine output              â”‚
â”‚  - Proactive suggestions                           â”‚
â”‚  - Nutritional insights                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Assistant Message                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Provider Strategy

Abstract behind a common interface. Support Anthropic (Claude) and OpenAI via env config.

### Environment Variables

```env
# AI provider: 'anthropic' | 'openai' | 'none' (default: 'none' = regex only)
AI_PROVIDER=anthropic

# Anthropic
ANTHROPIC_API_KEY=sk-ant-...
ANTHROPIC_MODEL=claude-sonnet-4-20250514  # fast + good at Finnish

# OpenAI
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini        # cost-effective, good structured output
```

### Provider Interface

```typescript
// src/lib/ai/types.ts

interface AIProvider {
  /** Parse user message into structured intent */
  parseMessage(
    message: string,
    context: AIConversationContext
  ): Promise<AIParseResult>;

  /** Generate natural Finnish response from engine output */
  generateResponse(
    engineOutput: EngineStepResult,
    context: AIConversationContext
  ): Promise<AIResponseResult>;

  /** Stream a response (for chat UX) */
  streamResponse?(
    engineOutput: EngineStepResult,
    context: AIConversationContext
  ): AsyncIterable<string>;
}

interface AIConversationContext {
  conversationState: ConversationState;
  mealType: MealType;
  timeOfDay: string;                    // "morning" | "afternoon" | "evening"
  resolvedItemNames: string[];          // Already logged foods
  pendingQuestion: PendingQuestion | null;
  fineliCandidates?: FineliFood[];      // For disambiguation context
  locale: 'fi' | 'en';
}
```

## 1. AI Parser â€” Structured Extraction

The AI parser replaces `classifyIntent()` + `parseMealText()`. It uses **structured output** (Anthropic tool_use / OpenAI function calling) for reliable JSON extraction.

### Input â†’ Output Contract

```typescript
interface AIParseResult {
  intent: 'add_items' | 'answer' | 'correction' | 'removal' | 'done' | 'unclear';

  // For add_items:
  items?: AIExtractedItem[];

  // For answer (to pending question):
  answer?: ParsedAnswer;      // Same types as regex parser

  // For correction:
  correction?: {
    type: 'correction' | 'update_portion';
    newText?: string;
    grams?: number;
  };

  // For removal:
  removal?: { targetText: string };

  // AI-enhanced extras:
  confidence: number;           // 0-1, fall back to regex if < 0.5
  searchHints?: string[];       // Better Fineli search terms
  portionEstimates?: Record<string, number>;  // AI's gram estimates per item
}

interface AIExtractedItem {
  /** The food name (normalized Finnish) */
  text: string;
  /** Extracted amount */
  amount?: number;
  /** Extracted unit */
  unit?: string;
  /** AI confidence for this item */
  confidence: number;
  /** Better search term for Fineli (e.g., "kevytmaito" â†’ "maito, kevyt 1%") */
  searchHint?: string;
  /** AI's portion estimate in grams (e.g., "kuppi kahvia" â†’ 200) */
  portionEstimateGrams?: number;
}
```

### System Prompt Strategy

The system prompt gives the AI context about:
- Finnish food vocabulary and common abbreviations
- Typical Finnish portion sizes
- Current conversation state (what's been asked, what's pending)
- Available Fineli unit types for the active food

```
You are a Finnish food diary assistant. Extract structured food data from user messages.

CONTEXT:
- Current meal: {mealType} ({timeOfDay})
- Already logged: {resolvedItems}
- Pending question: {pendingQuestion or "none"}
- Available options: {candidates if disambiguating}

RULES:
- Always extract amounts when mentioned (120g, 2 dl, 1 kpl)
- Normalize Finnish case forms (maidolla â†’ maito, voilla â†’ voi)
- Suggest better Fineli search terms when you recognize the food
- Estimate portions when user uses informal language ("kuppi", "lautasellinen")
- For disambiguation answers, return the selected index (1-based)
- For portion answers, return grams or unit+amount
```

### Tool Definition (Anthropic)

```json
{
  "name": "parse_food_message",
  "description": "Extract structured food data from a Finnish food diary message",
  "input_schema": {
    "type": "object",
    "properties": {
      "intent": {
        "type": "string",
        "enum": ["add_items", "answer", "correction", "removal", "done", "unclear"]
      },
      "items": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "text": { "type": "string" },
            "amount": { "type": "number" },
            "unit": { "type": "string" },
            "searchHint": { "type": "string" },
            "portionEstimateGrams": { "type": "number" }
          },
          "required": ["text"]
        }
      },
      "answerIndex": { "type": "integer", "description": "1-based selection for disambiguation" },
      "answerGrams": { "type": "number", "description": "Gram amount for portion answer" },
      "answerUnit": { "type": "string" },
      "answerValue": { "type": "number" },
      "correctionText": { "type": "string" },
      "removalTarget": { "type": "string" },
      "companionResponse": { "type": "boolean" },
      "confidence": { "type": "number" }
    },
    "required": ["intent", "confidence"]
  }
}
```

## 2. AI Response Generator

Instead of template strings like `"LÃ¶ysin useita vaihtoehtoja hakusanalle..."`, AI generates natural conversational Finnish.

### Response Contexts

| Situation | Template (current) | AI-generated (example) |
|-----------|-------------------|----------------------|
| Disambiguation | "LÃ¶ysin useita vaihtoehtoja hakusanalle 'maito': 1) Maito, kevyt..." | "Maitoa lÃ¶ytyi muutamia â€” tarkoitatko kevytmaitoa (1%), rasvatonta vai tÃ¤ysmaitoa?" |
| Portion question | "Kuinka paljon: Kaurapuuro?" | "Paljonko kaurapuuroa sÃ¶it? Normaali lautasellinen on noin 250g." |
| Confirmation | "âœ“ Maito, kevyt, 200g" | "SelvÃ¤, lisÃ¤sin kevytmaitoa 2 dl (206g). ğŸ‘" |
| No match | "En lÃ¶ytÃ¤nyt 'xyz' Fineli-tietokannasta." | "Hmm, 'xyz' ei lÃ¶ydy FinelistÃ¤. Tarkoitatko kenties jotain nÃ¤istÃ¤, vai voitko kuvata tarkemmin?" |
| Completion | "Kaikki tallennettu!" | "Hienoa, aamiainen on kirjattu! YhteensÃ¤ noin 450 kcal. SÃ¶itkÃ¶ muuta?" |
| Companion | "KÃ¤ytitkÃ¶ maitoa kaurapuuron kanssa?" | "Kaurapuuron kanssa menee usein maitoa â€” lisÃ¤tÃ¤Ã¤nkÃ¶?" |

### Response Generation Prompt

```
Generate a natural Finnish response for a food diary chatbot.

ENGINE OUTPUT:
- Action: {action type}
- Food: {food name}
- Portion: {grams}g
- Nutrients: {summary}
- Next question: {if any}

STYLE:
- Friendly, casual Finnish ("sinÃ¤" form)
- Brief (1-2 sentences max)
- Include relevant nutritional info when helpful
- Use emoji sparingly (âœ“ for confirmations)
- If asking a question, suggest typical portions
```

## 3. Smart Suggestions (New Capability)

AI adds proactive intelligence beyond the hardcoded `FOOD_COMPANIONS` map:

### Missing Item Detection
```
User logged: kaurapuuro (300g)
AI suggests: "Unohtuiko maito tai hunaja puuron kanssa?"
```

### Portion Sanity Check
```
User says: "500g kahvia"
AI: "500g kahvia on aika paljon â€” tarkoitatko ehkÃ¤ 5 dl (noin 500ml)?"
```

### Nutritional Insights (after meal completion)
```
"Lounaalla oli yhteensÃ¤ 680 kcal, 35g proteiinia. HyvÃ¤ proteiinimÃ¤Ã¤rÃ¤! ğŸ’ª"
```

### Time-Based Suggestions
```
Time: 15:00, meal: snack
AI: "VÃ¤lipalaksi vaikka hedelmÃ¤ tai jogurtti?"
```

## 4. Integration Points

### Modified Engine Signature

```typescript
// Before:
processMessage(userMessage, state, fineliClient, portionConverter)

// After:
processMessage(userMessage, state, fineliClient, portionConverter, aiProvider?)
```

When `aiProvider` is provided:
1. Call `aiProvider.parseMessage()` instead of regex `classifyIntent()`
2. If AI confidence < 0.5, fall back to regex parser
3. Use AI `searchHint` for better Fineli queries
4. Use AI `portionEstimateGrams` to pre-fill portion when asking
5. After engine processing, call `aiProvider.generateResponse()` for the reply

### Streaming Support

For chat UX, AI responses can be streamed:

```typescript
// API route: POST /api/chat
export async function POST(req: Request) {
  // ... process message ...

  if (aiProvider?.streamResponse) {
    const stream = aiProvider.streamResponse(engineResult, context);
    return new Response(
      new ReadableStream({
        async start(controller) {
          for await (const chunk of stream) {
            controller.enqueue(new TextEncoder().encode(chunk));
          }
          controller.close();
        }
      }),
      { headers: { 'Content-Type': 'text/event-stream' } }
    );
  }

  return Response.json(engineResult);
}
```

## 5. Cost Analysis

### Per-Message Cost (Claude 3.5 Haiku / GPT-4o-mini)

| Step | Input tokens | Output tokens | Cost |
|------|-------------|---------------|------|
| Parse | ~300 | ~100 | ~$0.0004 |
| Response | ~200 | ~80 | ~$0.0003 |
| **Total** | **~500** | **~180** | **~$0.0007** |

At ~10 messages per meal, ~3 meals/day: **~$0.02/user/day** or **~$0.60/user/month**.

### Cost Optimization

- **Cache common parses**: "120g kanaa" always means the same thing
- **Skip AI for simple answers**: "1", "2", "kyllÃ¤", "ei" â†’ regex is sufficient
- **Batch suggestions**: Generate companion suggestions + nutritional insight in one call
- **Use cheaper models for simple tasks**: Haiku for parsing, Sonnet for response generation

## 6. Fallback Strategy

```
AI Provider available?
  â”œâ”€â”€ YES: Use AI parser + AI response
  â”‚     â””â”€â”€ AI confidence < 0.5?
  â”‚           â”œâ”€â”€ YES: Fall back to regex parser
  â”‚           â””â”€â”€ NO: Use AI result
  â””â”€â”€ NO: Use regex parser + template responses (current behavior)
```

No AI provider configured = app works exactly as before.

## 7. File Structure

```
src/lib/ai/
â”œâ”€â”€ types.ts              # AIProvider interface, AIParseResult, etc.
â”œâ”€â”€ config.ts             # Provider selection from env
â”œâ”€â”€ prompts.ts            # System prompts, tool definitions
â”œâ”€â”€ anthropic.ts          # Anthropic/Claude provider implementation
â”œâ”€â”€ openai.ts             # OpenAI provider implementation
â”œâ”€â”€ ai-parser.ts          # AI-enhanced parser (wraps providers)
â”œâ”€â”€ ai-responder.ts       # AI response generator
â”œâ”€â”€ fallback.ts           # Confidence check + regex fallback logic
â””â”€â”€ __tests__/
    â”œâ”€â”€ ai-parser.test.ts
    â”œâ”€â”€ ai-responder.test.ts
    â””â”€â”€ providers.test.ts
```

## 8. Implementation Order

| Phase | Task | Assignee | Depends on |
|-------|------|----------|------------|
| P1 | Provider interface + types | Cursor | â€” |
| P2 | Anthropic provider | Cursor | P1 |
| P3 | OpenAI provider | Claude-code | P1 |
| P4 | AI parser with tool_use | Cursor | P2 |
| P5 | AI response generator | Claude-code | P2, P3 |
| P6 | Engine integration (opt-in) | Cursor | P4, P5 |
| P7 | Streaming API route | Claude-code | P6 |
| P8 | Frontend streaming chat | Claude-code | P7 |
| P9 | Tests | Both | P4, P5 |

## 9. Example Conversations

### Current (regex-based)

```
User: sÃ¶in aamupalaksi kaurapuuroa maidolla ja pari viipaletta leipÃ¤Ã¤
Bot:  LisÃ¤sin 3 ruokaa.
      LÃ¶ysin useita vaihtoehtoja hakusanalle "kaurapuuroa":
        1) Kaurapuuro, vedellÃ¤
        2) Kaurapuuro, maidolla
      Kumman tarkoitat? Vastaa numerolla 1â€“2.
User: 2
Bot:  Kuinka paljon: Kaurapuuro, maidolla?
      â€¢ pieni (200g)
      â€¢ keskikokoinen (300g)
      â€¢ iso (450g)
      â€¢ tai grammoina
User: normaali
Bot:  En ymmÃ¤rtÃ¤nyt mÃ¤Ã¤rÃ¤Ã¤. Kuinka paljon: Kaurapuuro, maidolla? ...
```

### With AI

```
User: sÃ¶in aamupalaksi kaurapuuroa maidolla ja pari viipaletta leipÃ¤Ã¤
Bot:  SelvÃ¤! LisÃ¤sin aamiaiselle:
      â€¢ Kaurapuuro maidolla â€” paljonko sÃ¶it? Normaali lautasellinen on ~300g.
      â€¢ LeipÃ¤ â€” minkÃ¤laista leipÃ¤Ã¤ ja montako viipaletta?

User: normaali annos puuroa ja 2 viipaletta ruisleipÃ¤Ã¤
Bot:  âœ“ Kaurapuuro maidolla, 300g (330 kcal)
      âœ“ RuisleipÃ¤, 2 viipaletta (60g, 130 kcal)
      Laitoitko voita tai juustoa leivÃ¤n pÃ¤Ã¤lle?

User: vÃ¤hÃ¤n voita
Bot:  âœ“ Voi, 10g (75 kcal)
      Aamiainen yhteensÃ¤ ~535 kcal, 18g proteiinia.
      SÃ¶itkÃ¶ muuta?
```

The AI version is dramatically more natural, handles "normaali annos" intelligently, and proactively asks about butter on bread â€” something the regex parser cannot do.
