---
description: Database patterns — Drizzle ORM, PostgreSQL, schema, soft-delete
globs: "src/lib/db/**/*.ts,src/app/api/**/*.ts,drizzle.config.ts"
alwaysApply: false
---

# Database Conventions

## Backend

- PostgreSQL (`pg`) is the only database backend.
- Use `getDbUnified()` in all route handlers — returns an async API.

## Schema

- Schema: `src/lib/db/schema.ts` (PostgreSQL, using `drizzle-orm/pg-core`).
- Deploy with `pnpm db:push` (drizzle-kit push), not migration files.

## Query Patterns

```typescript
const db = await getDbUnified();
const raw = db.raw;
const s = db.schema;

const rows = await db.selectAll(
  raw.select().from(s.diaryDays).where(
    and(
      eq(s.diaryDays.userId, session.userId),
      isNull(s.diaryDays.deletedAt)
    )
  )
);
```

## Soft-Delete

All main tables have a `deletedAt` column. **Always** filter with `isNull(table.deletedAt)` in queries. Never hard-delete rows — set `deletedAt` to current timestamp instead.

## IDs

- Primary keys are text UUIDs generated with `nanoid` (from `@/types`).
- Use `newId()` to generate new IDs.
